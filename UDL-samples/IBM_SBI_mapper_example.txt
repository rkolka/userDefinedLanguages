  Input Standards Association                                                                       Output Standards Association                                                                        
                                                                                                                                                                                                        
  Agency :                                E            Edifact                                      Agency :                                                                                            
  Version :                               D  93AEAN00 EANCOM 1994 RELEASE  (BASED ON EDIFACT D  93A Version :                                                                                           
  Transaction Set :                       ORDERS      PURCHASE ORDER MESSAGE                        Transaction Set :                                                                                   
  Release :                               0                                                         Release :                                 0                                                         
  Functional Group :                                                                                Functional Group :                                                                                  
                                                                                                                                                                                                        
                                                                                                                                                                                                        
                                                                                                                                                                                                        
  Extended Rules                                                                                                                                                                                        
  --------------                                                                                                                                                                                        
                                                                                                                                                                                                        
  ORDERS                                                                                                                                                                                                
  On Begin                                                                                                                                                                                              
  STRING[6] BY6;                                                                                                                                                                                        
  STRING[13] NADSU;                                                                                                                                                                                     
  STRING[13] NADBY;                                                                                                                                                                                     
  STRING[13] NADDP;                                                                                                                                                                                     
  STRING[20] BYSU;                                                                                                                                                                                      
  STRING[30] DPSU;                                                                                                                                                                                      
  STRING[40] BYDPSU;                                                                                                                                                                                    
  STRING[30] RESULT_IN_RAYON;                                                                                                                                                                           
  STRING[35] EAN;                                                                                                                                                                                       
  STRING[35] BELNR;                                                                                                                                                                                     
  STRING[19] PCBON;                                                                                                                                                                                     
  STRING[1] PCBYES;                                                                                                                                                                                     
  STRING[15] QTY_CHAR;                                                                                                                                                                                  
  STRING[6] PEMMEN;                                                                                                                                                                                     
  STRING[17] DPMEN;                                                                                                                                                                                     
  STRING[17] BYMEN;                                                                                                                                                                                     
  STRING[10] DPPARTN;                                                                                                                                                                                   
  STRING[10] DOPARTN;                                                                                                                                                                                   
  STRING[1] OP;                                                                                                                                                                                         
  STRING[1] F_GPA;                                                                                                                                                                                      
  STRING[13] tmp_DOPARTN;                                                                                                                                                                               
  STRING[13] tmp_DPPARTN;                                                                                                                                                                               
  STRING[30] tmp_receiver;                                                                                                                                                                              
  string[100] temp1;                                                                                                                                                                                    
                                                                                                                                                                                                        
  integer temp;                                                                                                                                                                                         
                                                                                                                                                                                                        
  string[20] temp_FIELD1;                                                                                                                                                                               
  string[20] temp_FIELD2;                                                                                                                                                                               
                                                                                                                                                                                                        
  // Variables created to handle errors.                                                                                                                                                                
  string[255] message_error[10];                                                                                                                                                                        
  string[1] index_error;                                                                                                                                                                                
  integer code_error[10];                                                                                                                                                                               
  integer i;                                                                                                                                                                                            
  integer has_error;                                                                                                                                                                                    
                                                                                                                                                                                                        
                                                                                                                                                                                                        
                                                                                                                                                                                                        
  BY6 = "";                                                                                                                                                                                             
  BYDPSU = "";                                                                                                                                                                                          
  NADSU = "";                                                                                                                                                                                           
  BELNR = "";                                                                                                                                                                                           
  NADBY = "";                                                                                                                                                                                           
  NADDP = "";                                                                                                                                                                                           
  BYSU = "";                                                                                                                                                                                            
  DPSU = "";                                                                                                                                                                                            
  EAN = "";                                                                                                                                                                                             
  RESULT_IN_RAYON = "";                                                                                                                                                                                 
  PCBON = "";                                                                                                                                                                                           
  PCBYES = "N";                                                                                                                                                                                         
  QTY_CHAR = "";                                                                                                                                                                                        
  PEMMEN = "";                                                                                                                                                                                          
  DPPARTN = "";                                                                                                                                                                                         
  DOPARTN = "";                                                                                                                                                                                         
  DPMEN = "";                                                                                                                                                                                           
  BYMEN = "";                                                                                                                                                                                           
  OP = "";                                                                                                                                                                                              
  F_GPA = "";                                                                                                                                                                                           
  tmp_DOPARTN = "";                                                                                                                                                                                     
  tmp_DPPARTN = "";                                                                                                                                                                                     
  tmp_receiver = "";                                                                                                                                                                                    
  temp1 = "";                                                                                                                                                                                           
                                                                                                                                                                                                        
  temp = 0;                                                                                                                                                                                             
                                                                                                                                                                                                        
  temp_FIELD1 = "";                                                                                                                                                                                     
  temp_FIELD2 = "";                                                                                                                                                                                     
                                                                                                                                                                                                        
  i = 0;                                                                                                                                                                                                
  has_error = 0;                                                                                                                                                                                        
  index_error = "0";                                                                                                                                                                                    
                                                                                                                                                                                                        
  while i < 10 do                                                                                                                                                                                       
  begin                                                                                                                                                                                                 
                                                                                                                                                                                                        
      code_error[i] = 0;                                                                                                                                                                                
      message_error[i] = "";                                                                                                                                                                            
                                                                                                                                                                                                        
      i = i + 1;                                                                                                                                                                                        
  end                                                                                                                                                                                                   
                                                                                                                                                                                                        
  i = 0;                                                                                                                                                                                                
  On End                                                                                                                                                                                                
  STRING[3] LOYALTY_PROGRAM;                                                                                                                                                                            
  string[500] temp1;                                                                                                                                                                                    
  integer temp;                                                                                                                                                                                         
                                                                                                                                                                                                        
  i = 0 ;                                                                                                                                                                                               
  LOYALTY_PROGRAM = "";                                                                                                                                                                                 
                                                                                                                                                                                                        
  IF NADSU != "" & BY6 != "" & NADBY != "" & NADDP != "" THEN                                                                                                                                           
  BEGIN                                                                                                                                                                                                 
  	BYSU = BY6+"-"+NADSU;                                                                                                                                                                                
  	DPSU = NADDP+NADSU;                                                                                                                                                                                  
      BYDPSU = NADBY+NADDP+NADSU;                                                                                                                                                                       
                                                                                                                                                                                                        
  	SELECT DESCRIPTION INTO RESULT_IN_RAYON FROM CODELIST WHERE SENDERCODE = BYSU AND NAME = "in_rayon";                                                                                                 
                                                                                                                                                                                                        
  	#MESFCT = mid(RESULT_IN_RAYON,28,3);                                                                                                                                                                 
  	PEMMEN  = mid(RESULT_IN_RAYON,28,3);                                                                                                                                                                 
  	#MESCOD = mid(RESULT_IN_RAYON,11,3);                                                                                                                                                                 
                                                                                                                                                                                                        
  	$TMP_ORG_DATA[1].#VALEUR = mid(RESULT_IN_RAYON,0,4);                                                                                                                                                 
  	$TMP_ORG_DATA[1].#QUALF = "008";                                                                                                                                                                     
                                                                                                                                                                                                        
  	$TMP_ORG_DATA[2].#VALEUR = mid(RESULT_IN_RAYON,5,2);                                                                                                                                                 
  	$TMP_ORG_DATA[2].#QUALF = "007";                                                                                                                                                                     
                                                                                                                                                                                                        
  	$TMP_ORG_DATA[3].#VALEUR = mid(RESULT_IN_RAYON,8,2);                                                                                                                                                 
  	$TMP_ORG_DATA[3].#QUALF = "006";                                                                                                                                                                     
                                                                                                                                                                                                        
  	$TMP_ORG_DATA[4].#VALEUR = mid(RESULT_IN_RAYON,15,4);                                                                                                                                                
  	$TMP_ORG_DATA[4].#QUALF = "012";                                                                                                                                                                     
                                                                                                                                                                                                        
  	$TMP_ORG_DATA[5].#VALEUR = mid(RESULT_IN_RAYON,20,3);                                                                                                                                                
  	$TMP_ORG_DATA[5].#QUALF = "019";                                                                                                                                                                     
                                                                                                                                                                                                        
  	$ORDERS.#MESTYP = "ORDERS" ;                                                                                                                                                                         
  	                                                                                                                                                                                                     
  	// Ecriture de la référence de commande Entreprise si présente                                                                                                                                              
  	// Présence détectée sur les postes par l'occurence de RFF+VN.                                                                                                                                       
  	IF F_GPA = "1" THEN                                                                                                                                                                                  
  	BEGIN                                                                                                                                                                                                
  		$TMP_ORG_DATA[4].#VALEUR = mid(RESULT_IN_RAYON,15,2) + "TB";                                                                                                                                        
  		$TMP_ORG_DATA[4].#QUALF = "012";                                                                                                                                                                    
  		                                                                                                                                                                                                    
  		$TMP_ORG_DATA[5].#VALEUR = "GPA2";                                                                                                                                                                  
  		$TMP_ORG_DATA[5].#QUALF = "019";                                                                                                                                                                    
  		                                                                                                                                                                                                    
  		$ORDERS.#MESTYP = "ZZRGPA" ;                                                                                                                                                                        
  		$ORDERS.#ACTION = "000" ;                                                                                                                                                                           
  	END                                                                                                                                                                                                  
                                                                                                                                                                                                        
                                                                                                                                                                                                        
  	IF NADSU = "3017003425706"  THEN                                                                                                                                                                     
  	BEGIN                                                                                                                                                                                                
  		//Recherche DO LP AUCHAN                                                                                                                                                                            
  		LOYALTY_PROGRAM ="YES";                                                                                                                                                                             
                                                                                                                                                                                                        
  		SELECT DESCRIPTION INTO DOPARTN FROM CODELIST WHERE SENDERCODE = BYDPSU AND NAME = "in_client";                                                                                                     
  		IF DOPARTN = "" THEN                                                                                                                                                                                
  			cerror (100, "Parametrage DO LP AUCHAN manquant dans in_client");                                                                                                                                  
                                                                                                                                                                                                        
  		//Recherche DP LP AUCHAN                                                                                                                                                                            
  		SELECT DESCRIPTION INTO DPPARTN FROM CODELIST WHERE SENDERCODE = DPSU AND NAME = "in_clientSH";                                                                                                     
  		IF DPPARTN = "" THEN                                                                                                                                                                                
  			cerror (100, "Parametrage DP LP AUCHAN manquant dans in_clientSH");                                                                                                                                
  	END                                                                                                                                                                                                  
                                                                                                                                                                                                        
  	IF NADSU != "3017003425706"  THEN                                                                                                                                                                    
  	BEGIN                                                                                                                                                                                                
  		BYMEN = NADBY+PEMMEN;                                                                                                                                                                               
  		DPMEN = NADDP+PEMMEN;                                                                                                                                                                               
  	                                                                                                                                                                                                     
  		SELECT DESCRIPTION INTO DOPARTN FROM CODELIST WHERE SENDERCODE = BYMEN AND NAME = "in_client";                                                                                                      
  		IF DOPARTN = "" THEN                                                                                                                                                                                
  			SELECT DESCRIPTION INTO DOPARTN FROM CODELIST WHERE SENDERCODE = NADBY AND NAME = "in_client";                                                                                                     
                                                                                                                                                                                                        
  		SELECT DESCRIPTION INTO DPPARTN FROM CODELIST WHERE SENDERCODE = DPMEN AND NAME = "in_client";                                                                                                      
  		IF DPPARTN = "" THEN                                                                                                                                                                                
  			SELECT DESCRIPTION INTO DPPARTN FROM CODELIST WHERE SENDERCODE = NADDP AND NAME = "in_client";                                                                                                     
  	                                                                                                                                                                                                     
  	END                                                                                                                                                                                                  
  	IF (DOPARTN = "" & DPPARTN = "")                                                                                                                                                                     
  	THEN BEGIN                                                                                                                                                                                           
                                                                                                                                                                                                        
  		SELECT DESCRIPTION INTO tmp_DOPARTN FROM CODELIST WHERE SENDERCODE = NADBY AND NAME = "AUCHAN_GLN_MAGASIN";                                                                                     
                                                                                                                                                                                                        
  		SELECT DESCRIPTION INTO tmp_DPPARTN FROM CODELIST WHERE SENDERCODE = NADDP AND NAME = "AUCHAN_GLN_MAGASIN";                                                                                     
                                                                                                                                                                                                        
  		SELECT RECEIVERCODE INTO tmp_receiver FROM CODELIST WHERE SENDERCODE = NADDP AND NAME = "AUCHAN_GLN_MAGASIN";                                                                                   
                                                                                                                                                                                                        
  		IF (DOPARTN = tmp_DOPARTN & DPPARTN = tmp_DPPARTN)                                                                                                                                                  
  		THEN BEGIN                                                                                                                                                                                          
  			                                                                                                                                                                                                   
  			message_error[1] =  "Commande Entreprise Auchan en erreur à vérifier : "+ tmp_receiver +" // GLN NAD BY et NAD DP "+ NADBY + " non reconnu dans la table EDI in_client et AUCHAN_GLN_MAGASIN (Map EDI 
  EDIFACT_ORDERS_AUCHAN)";                                                                                                                                                                                
                          code_error[1] = 1;                                                                                                                                                            
  			                                                                                                                                                                                                   
  		END                                                                                                                                                                                                 
                  ELSE BEGIN                                                                                                                                                                            
                                                                                                                                                                                                        
  			code_error[0] = 2;                                                                                                                                                                                 
  			message_error[0] = "Commande Entreprise Auchan directe magasin "+ $ORDERS.#NUM_CDE +" // Le GLN "+ NADBY + " est enregistré dans la base EDI AUCHAN_GLN_MAGASIN (Map EDI EDIFACT_ORDERS_AUCHAN) ";   			
  						                                                                                                                                                                                                
                                                                                                                                                                                                        
                                                                                                                                                                                                        
                  END                                                                                                                                                                                   
                                                                                                                                                                                                        
  	END                                                                                                                                                                                                  
          ELSE BEGIN                                                                                                                                                                                    
                                                                                                                                                                                                        
                                                                                                                                                                                                        
  		IF DOPARTN = "" THEN                                                                                                                                                                                
                         cerror (100, "NADBY non parametre dans in_client vérifier unitairement pour envoie Entreprise dans AUCHAN_GLN_MAGASIN");                                                          
                                                                                                                                                                                                        
                  IF DPPARTN = "" THEN                                                                                                                                                                  
                                                                                                                                                                                                        
                         cerror (100, "NADDP non parametre dans in_client vérifier unitairement pour envoie Entreprise dans AUCHAN_GLN_MAGASIN");                                                          
                                                                                                                                                                                                        
          END                                                                                                                                                                                           
                                                                                                                                                                                                        
                                                                                                                                                                                                        
                                                                                                                                                                                                        
  	$TMP_BY_DP[1].#QUAL_PARTN = "AG";                                                                                                                                                                    
  	$TMP_BY_DP[1].#PARTN = DOPARTN;                                                                                                                                                                      
                                                                                                                                                                                                        
  	$TMP_BY_DP[2].#QUAL_PARTN = "WE";                                                                                                                                                                    
  	$TMP_BY_DP[2].#PARTN = DPPARTN;                                                                                                                                                                      
                                                                                                                                                                                                        
  	#SNDPRN = DOPARTN;                                                                                                                                                                                   
  		                                                                                                                                                                                                    
  END                                                                                                                                                                                                   
                                                                                                                                                                                                        
  // Error and duplicate check management.                                                                                                                                                              
                                                                                                                                                                                                        
                                                                                                                                                                                                        
                                                                                                                                                                                                        
  while i < 10 do                                                                                                                                                                                       
  begin                                                                                                                                                                                                 
                                                                                                                                                                                                        
      if code_error[i] != 0 then                                                                                                                                                                        
      begin                                                                                                                                                                                             
                                                                                                                                                                                                        
          // Individual error management                                                                                                                                                                
          ntoa(code_error[i], index_error);                                                                                                                                                             
          update processdata set xpathresult = "X" where xpath = "/ProcessData/NO_SEND";                                                                                                                
          update processdata set xpathresult = message_error[i] where xpath = "/ProcessData/EDI_ERROR_FROM_MAP";                                                                                        
          update processdata set xpathresult = index_error where xpath = "/ProcessData/EDI_CASE_FROM_MAP";                                                                                              
                                                                                                                                                                                                        
          has_error = 1;                                                                                                                                                                                
                                                                                                                                                                                                        
          //cerror(666, message_error[i]);                                                                                                                                                              
                                                                                                                                                                                                        
      end                                                                                                                                                                                               
                                                                                                                                                                                                        
      i = i + 1;                                                                                                                                                                                        
  end                                                                                                                                                                                                   
                                                                                                                                                                                                        
                                                                                                                                                                                                        
  if has_error = 0 then                                                                                                                                                                                 
  begin                                                                                                                                                                                                 
      // Duplicate check                                                                                                                                                                                
      UPDATE TRANSACTIONREGISTER SET FIELD1 = temp_FIELD1;                                                                                                                                              
      UPDATE TRANSACTIONREGISTER SET FIELD2 = temp_FIELD2;                                                                                                                                              
                                                                                                                                                                                                        
      temp = select FIELD1 into temp1 from TRANSACTIONREGISTER;                                                                                                                                         
      if temp = 1 then                                                                                                                                                                                  
      begin                                                                                                                                                                                             
                                                                                                                                                                                                        
          temp1 = "Message ORDERS Auchan en doublon, commande : " + temp_FIELD1;                                                                                                                        
          update processdata set xpathresult = "X" where xpath = "/ProcessData/NO_SEND";                                                                                                                
          update processdata set xpathresult = temp1 where xpath = "/ProcessData/EDI_ERROR_FROM_MAP";                                                                                                   
          update processdata set xpathresult = "3" where xpath = "/ProcessData/EDI_CASE_FROM_MAP"; // Using code 3 for code list                                                                        
                                                                                                                                                                                                        
      end                                                                                                                                                                                               
                                                                                                                                                                                                        
  end                                                                                                                                                                                                   
  ORDERS.1004                                                                                                                                                                                           
  #TRN_CDE = #1004 ;                                                                                                                                                                                    
  temp_FIELD1 = #1004;                                                                                                                                                                                  
  BELNR = #1004 ;                                                                                                                                                                                       
                                                                                                                                                                                                        
  IF #1225 = "6" Then                                                                                                                                                                                   
  BEGIN                                                                                                                                                                                                 
  F_GPA ="1";                                                                                                                                                                                           
  BELNR = "GPAEntreprise" + mid(#1004, 2, 8) ;                                                                                                                                                                 
  //BELNR = "GPA" + mid(#1004, 2, 8) ;                                                                                                                                                                  
  END                                                                                                                                                                                                   
  DTM.2005                                                                                                                                                                                              
  IF #2005 = "137" THEN                                                                                                                                                                                 
  BEGIN                                                                                                                                                                                                 
    $TMP_DATE[1].#DATE_CDE = #2380 ;                                                                                                                                                                    
    $TMP_DATE[1].#IDDAT = "012" ;                                                                                                                                                                       
    $TMP_E1EDK02[1].#DATUM = #2380 ;                                                                                                                                                                    
  END                                                                                                                                                                                                   
                                                                                                                                                                                                        
  IF #2005 = "2" | #2005 = "2" THEN                                                                                                                                                                     
  BEGIN                                                                                                                                                                                                 
    $TMP_DATE[2].#DATE_CDE = #2380 ;                                                                                                                                                                    
    $TMP_DATE[2].#IDDAT = "002" ;                                                                                                                                                                       
  END                                                                                                                                                                                                   
  0010_RFF.1153                                                                                                                                                                                         
  if #1153 = "PD" then                                                                                                                                                                                  
  OP = "X";                                                                                                                                                                                             
  0020_NAD.3035                                                                                                                                                                                         
  if #3035 = "SU" then                                                                                                                                                                                  
  NADSU = #3039;                                                                                                                                                                                        
                                                                                                                                                                                                        
  if #3035 = "BY" then                                                                                                                                                                                  
  BY6 = left(#3039,6);                                                                                                                                                                                  
                                                                                                                                                                                                        
  if #3035 = "BY" then                                                                                                                                                                                  
  NADBY = #3039;                                                                                                                                                                                        
                                                                                                                                                                                                        
  if #3035 = "DP" then                                                                                                                                                                                  
  begin                                                                                                                                                                                                 
  NADDP = #3039;                                                                                                                                                                                        
  $ORDERS.#TRN_EAN_DP = #3039;                                                                                                                                                                          
  temp_FIELD2 = #3039;                                                                                                                                                                                  
                                                                                                                                                                                                        
                                                                                                                                                                                                        
    if OP = "X" then                                                                                                                                                                                    
    begin                                                                                                                                                                                               
    $ORDERS.#NUM_CDE = BELNR + "/OP" ;                                                                                                                                                                  
    $TMP_E1EDK02[1].#BELNR = BELNR + "/OP" ;                                                                                                                                                            
    end                                                                                                                                                                                                 
    else                                                                                                                                                                                                
    begin                                                                                                                                                                                               
    $ORDERS.#NUM_CDE = BELNR ;                                                                                                                                                                          
    $TMP_E1EDK02[1].#BELNR = BELNR ;                                                                                                                                                                    
    end                                                                                                                                                                                                 
  $TMP_E1EDK02[1].#QUAL = "001";                                                                                                                                                                        
  end                                                                                                                                                                                                   
  0500_LIN.1082                                                                                                                                                                                         
  $TMP_LIN[index(1)].#POSEX = #1082 ;                                                                                                                                                                   
  0500_LIN.7140                                                                                                                                                                                         
  EAN = #7140 ;                                                                                                                                                                                         
                                                                                                                                                                                                        
  PCBYES = "N";                                                                                                                                                                                         
  PCBON = mid(EAN,0,5)+"-"+NADSU;                                                                                                                                                                       
                                                                                                                                                                                                        
  SELECT DESCRIPTION INTO PCBYES FROM CODELIST WHERE SENDERCODE = PCBON AND NAME = "in_PCB";                                                                                                            
                                                                                                                                                                                                        
  QTY.6063                                                                                                                                                                                              
  IF #6063 = "21" | #6063 = "C11" THEN                                                                                                                                                                  
  BEGIN                                                                                                                                                                                                 
    $TMP_LIN[index(1)].#QTY = #6060 ;                                                                                                                                                                   
  END                                                                                                                                                                                                   
                                                                                                                                                                                                        
  IF #6063 = "59" & PCBYES = "N" THEN                                                                                                                                                                   
  BEGIN                                                                                                                                                                                                 
    $TMP_LIN[index(1)].#EAN[1] = EAN ;                                                                                                                                                                  
  END                                                                                                                                                                                                   
                                                                                                                                                                                                        
  IF #6063 = "59" & PCBYES = "O" THEN                                                                                                                                                                   
  BEGIN                                                                                                                                                                                                 
    QTY_CHAR = "";                                                                                                                                                                                      
    ntoa(#6060,QTY_CHAR);                                                                                                                                                                               
    $TMP_LIN[index(1)].#EAN[1] = EAN+"/"+QTY_CHAR ;                                                                                                                                                     
  END                                                                                                                                                                                                   
  0520_PRI.5125                                                                                                                                                                                         
  IF #5125 = "AAA" & ( #5387 = "NTP" | #5387 = "PRP" ) THEN                                                                                                                                             
  BEGIN                                                                                                                                                                                                 
    $TMP_LIN[index(1)].#VPREI = #5118;                                                                                                                                                                  
  END                                                                                                                                                                                                   
